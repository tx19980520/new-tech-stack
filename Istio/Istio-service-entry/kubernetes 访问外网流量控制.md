# kubernetes 访问外网流量控制

## ext-istio kubernetes 流量控制

我们清楚kubernetes在内网里面进行服务注册和通信的机制是基于CNI plugin和DNS服务，在kubernetes中可用的DNS服务主要为kube-dns和coredns，本集群中使用的CNI plugin为flannel，DNS服务为coredns，应该是比较普适的常规的配置。

首先我们先check pod内部的resolv.conf的情况

```
root@sms-redis-0:/data# cat /etc/resolv.conf 
nameserver 169.254.25.10
search default.svc.cluster.local svc.cluster.local cluster.local
options ndots:5
```

nameserver指向的是coredns服务的集群内部IP，主要查找的是集群内部的一些IP，如果集群内部无法查找，DNS服务会找到上游DNS服务器集训进行查找：

```conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "systemd-resolve --status" to see details about the actual nameservers.
nameserver 8.8.8.8
nameserver 114.114.114.114
nameserver 127.0.0.53
options timeout:2 attempts:3 rotate single-request-reopen

```

上文为服务器节点的DNS，coredns是依靠该resolv.conf来进行进一步的域名解析的，在之前没有设置的时候，我主机上的resolv.conf是不存在nameserver 8.8.8.8和nameserver 114.114.114.114这两个分别是google和中国移动的DNS服务器。我们需要对其进行添加。

在ubuntu 18.04版本中/etc/resolv.conf已经只是一个软链接了，如果需要修改，需要进行[此处](https://datawookie.netlify.com/blog/2018/10/dns-on-ubuntu-18.04/)的操作。

你可以进一步check/etc/resolv.conf，发现其已经修改

之后我们创建一个带curl的busybox我们可以curl httpbin.org

```bash
curl -I httpbin.org
HTTP/1.1 200 OK
Access-Control-Allow-Credentials: true
Access-Control-Allow-Origin: *
Content-Length: 9593
Content-Type: text/html; charset=utf-8
Date: Mon, 15 Jul 2019 02:56:31 GMT
Referrer-Policy: no-referrer-when-downgrade
Server: nginx
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Connection: keep-alive

```

### Istio egress control——Service Entry

由于本项目需要对外进行访问（sms与oss），因此我们需要进行vpc外部的公网的访问，我们会发现在这样的情况下，我们的服务无法进行外网的任何访问，在集群中我们配置了相应的coredns的配置，但仍旧不起作用，主要原因为Istio管控下的网格是默认无法进行外网的访问，我们需要手动配置ServiceEntry来允许相应。

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: aliyun-service-entry
spec:
  hosts:
  - dysmsapi.aliyuncs.com
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: DNS

```

进行简单的配置之后即可向外发送请求，进一步的配置可设置超时请求，可以允许指定的服务进行请求。

