# 测试

书第七章就测试类型和测试范围两个角度展开来论述微服务中的测试。

从测试范围的角度而言，范围从小到大依次为单元测试、服务测试和端到端测试，范围越大，与用户更加接近。

## 单元测试

单元测试注重的是快速反馈和快速模块内、服务内集成，主要覆盖的是服务内部的代码，单元测试甚至不会启动服务（在Springboot中使用Junit，有的单元测试只会启动单个Controller或者单个Service），对外部的文件和网络连接的使用也很有限。通常情况下你需要大量的单元测试。

## 服务测试

要完成服务测试，需要涉及到网络和其他服务，我们使用打桩服务来模拟真实的服务，这里我们留意，对于打桩服务如何维护，我们在后文会有所提及。

## 端到端测试

端到端测试是非常特殊的，想通过这种用户界面的测试覆盖涉及的所有服务，从而帮助我们了解系统的概况。进一步阅读书籍，会发现端到端测试中提及到“扇入”，实际上，在此会有一个集成这样的工作，在此集成也是为了能够在部署/上线之前能够及时的发现一些问题和特发情况。

对于不同规模的项目，最让人难以处理的实质上是服务测试和端到端测试，我们将分别对这两部分进行详细的阐述。

### 消费者驱动模式的测试

消费者驱动模式的测试基本能够解决服务测试的相L关问题，其中也能够解决测试维护的相关问题。即，消费者和生产者定义期望，这些期望会变成最终生产者的测试代码。如果使用得当，这些CDC(Consumer-Driver Con)应该成为生产者CI流水线的一部分，这样可以确保，如果这些契约被破坏了的话，生产者就无法部署。

文章中提及到Pact作为一个消费者驱动的测试工具，能够生成JSON格式的消费者规范来规范，相关的规范存储在CI/CD工具的构建仓库。

## 蓝绿部署和金丝雀部署

两种部署方式都属于部署后测试，蓝绿测试强调进行冒烟测试，之后完全将生产负载直接导向新版本服务，金丝雀发布更加强调的是缓步进行流量的引流，在整个过程中验证系统是否“预期执行”，注重完成新版本的“上线 ”。

> 有时花费相同的努力让发布变更变得更好，比添加更多的自动化功能测试更加有益。在Web操作的世界，这通常被称为平均故障间隔时间(MTBF)和平均修复时间(MTTR)之间的权衡优化。

> 即使我们仍在纠结是否让性能测试的环境真正类似于生产环境，性能测试对追踪性能的瓶颈仍然是有价值的，只是需要注意，结果可能是假阴性，甚至更遭，是假阳性。



## 元版本

> 为应用于多个服务上的修改使用相同的版本，会使我们很快接受这样的理念：同时修改和部署多个服务是可以接受的。这个成了常态，成了正常的情况。而这样做后，我们就会丢弃微服务的主要优势之一：独立于其他服务单独部署一个服务的能力。

这里所提到的是lock-step的一个问题，是在项目中遇到的问题。这个问题的根本更糟糕，不是说“我知道所有服务在这个版本下能够一起工作”，而是“只有在这个版本下，所有服务才能正常工作”。原因就在于，我们在数据库层面上就已经出现了耦合，每一次改动，如若需要修改数据库，必将的触发诸多的修改。（数据库守护者的审批，消费者的修改，都是破坏性的修改）。这种耦合在部署层面上又一次体现。