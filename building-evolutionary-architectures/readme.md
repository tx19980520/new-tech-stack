# 《演进式架构》

​        就《演进式架构》一书，结合 casecloud 进行批判性讨论的记录，子标题都是书中一些强调的点。希望能通过该书的相关引导，重新对 casecloud 进行架构的批判性审查。

## 适应度函数

​        适应度函数本来是遗传算法甚至可以认为是当今机器学习和人工智能领域方面的一个重要概念，本质上来讲就是建立数学模型进行极值求解。但是系统工程方面，目前为止非常难做到全部维度都数学化，因此需要架构师手动的进行权衡。适应度的测试，不仅仅是正确性方面的测试，更多的是围绕的架构是否能在今后健康发展的一个考核，很多的情况下，可能我们只会在项目初期对系统架构进行较为细致的设计。但是针对系统的设计，在演进式架构中，需要覆盖整个系统软件的声明周期，就宛如强调单元测试一样强调适应度考察，这个考察在后面我们会谈到，可以在CI/CD的过程中进行相关操作，这一切的一切都是为了防止架构的演进能力不退化。

​        适应度函数应当选择相关的架构特征，剔除无关特征，通过相关技术，在架构的生命周期中，不断的进行权衡和。

​        适应度函数会引导系统架构的演进，在我理解而言，适应度函数也不是永恒真理，也是会随着时间的推移发生改变的，其仅仅是相对产品需求是较为稳定的，这也是架构师的工作之一，解决相应

​        就适应度函数而言，casecloud 主要关注的是以下几个维度：

​		**安全**：安全方面是因为这涉及法律方面的相关内容，需要做到数据安全和流程正义，casecloud 没有考察审计性，这也是一点过失。

​		**可修改**：主要的压力是来自甲方的需求变更程度的大，可修改层面上需要着重考量。

​		**可学习性**：casecloud 最终是需要给到用户进行使用的，因此至少从前端页面而言，可学习性就非常有必要，确实在后续有提出制作相关的帮助文档进行学习，但是该项工作没有持续的进行下去。

​		**数据**：这里比较笼统的谈到数据，是因为数据方面和安全和可修改都有一些关系，但是又是客户最为关注的一点。数据要保证合法有效，就必须保证原子等一些数据方面的特征，甚至和审计也有相当大的关系。

​		当然，casecloud在某些方面可以认为是并不会有过大的关注的。例如性能，就 qps 而言 casecloud上同时进行操作的人数并不会太多，每一个操作对于用户而言也可谓是至关重要的，因此用户不会盲目的进行操作，因此 qps 并不会太多。因此我们就不应该为了性能而随意丢弃在数据层面上原子性和持久性的相关操作，甚至为了加强数据上的安全，需要一些额外的工作——给 MongoDB 使用 MTLS，使用 replica 模式的 MongoDB 以及进行持久化落盘。

​		一开始非常理想，但是适应度函数在后续的开发过程中完全没有起到引导作用，大量的操作都是背离适应度函数进行设计的。例如数据库的强耦合设计，对于数据方面实际没有什么大的影响，但实际的设计却无时无刻不体现着对可修改性的破坏。Mongodb + MySQL 实际上是一个比较好的设计，Mongodb 一定程度上使得数据库方面的可修改性得到了加强，另一方面在代码层面上进行更多的保障之后，仍旧可以保证原子性，但是在实现中就完全没有相关的设计和考察（这种情况应该是可以用单测直接测出来的）。

​		适应度函数的考量方式上，确实不同维度有不同的考量方法，书中给到的scientist的相关内容，更多的是在生产环境，或者预发环境中进行的相关内容，进行一个不同版本的一致性验证，其实我们在更上层镜像流量上同样可以做到这一点，但这样的思想都是在于，建立一个完整的一致性测试。

## 不同架构的演进能力

这个部分的实际内容建议观看原书内容，比较详细。我在 image 中留存了相关内容的原文，在此我更希望探讨的是事件驱动架构部分和 SOA 部分的工作因为这和 casecloud 的两次架构改进都有莫大的关联。

### 事件驱动架构

​        代理模式是一种纯粹的以 event 的方式驱动各部分进行工作，耦合程度非常低，并行程度较高，但是因为是完全的事件驱动，因此缺乏协调性和相关错误处理的方式，这一点而言，就 casecloud 在可修改性方面将得到大幅度的提升，但是另一方面，数据方面我认为将会出现比较大的动摇，如果某些模块在运行过程中出现错误没有完成处理，则会出现一些数据层面上难以修复的情况，各个模块的似乎在这个层面上又出现了一些耦合。原文也提到，由于上述的异步性质的内容，将会导致我们的代码在某个模块内比较好测试，但是非常难以对某个流程进行测试，同时定位问题也成为难点，需要靠死信队列兜底，以及 tracing 的相关内容。tracing 和死信队列兜底这两点，都是为数据做保障。

​		中介模式在我看来，就是拥有总线，通信靠队列的 SOA，可能我认为更加偏向于 SOA ，这种架构更加能够做好更加宏观的测试和度量，并行性也没有特别的降低，异常处理上得到提升，但是也增加了耦合，妨碍了演进。

### 服务导向架构

​		企业服务总线驱动强大点就是在总线的编排能力上，总线一方面能够编排已有的模块，一方面也为加入新的模块提供了相当大的可行性，但是一定程度上，拥有了总线也就难以做到敏捷，这也是 ESB 驱动的 SOA 不是演进式架构的原因之一。当时 casecloud 在第一次翻版的情况下，有意添加总线在 apigateway 的层面，各服务专注于服务，gateway 负责服务的编排，但关于服务能够给到的接口当时其实并没有给到很好的设计，各个服务的接口的参数和返回值实际是没有任何限制的，导致 gateway 服务内部没法做到在编码层面上就发现相关的接口不 match 的错误。另一方面，总线需要一个完全了解业务逻辑的人去写，工作量也相对较大。

​		微服务的架构主要还是业务驱动，业务驱动是一个很深入的学问，甚至很多大公司的微服务划分在一开始都是不太成功的，最终又回归单体。微服务让架构量子变小，数据库也进入到了架构量子中，因此数据库层面应当也不存在耦合，从我们关注的数据的适应度而言，也保证了数据的安全和原子性。

### “无服务”架构

​        这里聊到无服务架构，主要是看到文中作者的一个观点就是“运营商为王”反模式，这确实是我近期研究 serverless，使用 lambda function 和 阿里云函数服务的一大问题，感觉只要使用了相关的工作方式，就与运营商进行了绑定。

